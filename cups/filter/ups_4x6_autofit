#!/usr/bin/env bash
set -euo pipefail

INPUT="${6:-/dev/stdin}"

# Printer DPI
DPI=203

# 4x6 inches in pixels at 203 dpi
OUT_W=$((4 * DPI))   # 812
OUT_H=$((6 * DPI))   # 1218

# UPS label is typically in top-left of letter, rotated.
# We'll render the page, then crop top-left region and rotate to fit 4x6 portrait.
TMPDIR="$(mktemp -d /tmp/upslabel.XXXXXX)"
trap 'rm -rf "$TMPDIR"' EXIT

PNG_PAGE="$TMPDIR/page.png"
PNG_CROP="$TMPDIR/crop.png"
PDF_OUT="$TMPDIR/out.pdf"

# Render first page at DPI to PNG (no transparency issues)
# Use -dFirstPage/-dLastPage to keep it fast
/usr/bin/gs -q -dNOPAUSE -dBATCH \
  -sDEVICE=pnggray \
  -r${DPI} \
  -dFirstPage=1 -dLastPage=1 \
  -sOutputFile="$PNG_PAGE" \
  "$INPUT"

# Crop top-left area then rotate and resize to 4x6 pixels.
# You may need to tweak crop geometry depending on your UPS PDF layout.
# Format: WxH+X+Y (pixels). Start with roughly a 4x6 region from top-left.
# For letter at 203dpi: 8.5x11 => 1726x2233 px
CROP_W=$OUT_H   # because label is sideways, we'll take 6" width worth before rotate
CROP_H=$OUT_W   # and 4" height worth
X=102
Y=203

convert "$PNG_PAGE" -crop ${CROP_W}x${CROP_H}+${X}+${Y} +repage \
  -rotate 90 \
  -resize ${OUT_W}x${OUT_H}! \
  "$PNG_CROP"

# Wrap cropped image into a 4x6 PDF
convert "$PNG_CROP" -units PixelsPerInch -density ${DPI} "$PDF_OUT"

cat "$PDF_OUT"
